<!DOCTYPE html>
<html>
<head>
    <title>Code 39 Barcode Scanner</title>
    <script src="https://cdn.jsdelivr.net/npm/quagga/dist/quagga.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        #scanner-container {
            width: 100%;
            height: 300px;
            border: 2px solid #333;
            position: relative;
            margin: 20px 0;
        }
        #result {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            font-size: 18px;
        }
        .new-scan {
            background-color: #e8f5e9;
            border: 1px solid #a5d6a7;
            color: #2e7d32;
        }
        .duplicate-scan {
            background-color: #ffebee;
            border: 1px solid #ef9a9a;
            color: #c62828;
        }
        .error {
            background-color: #fff3e0;
            border: 1px solid #ffcc80;
            color: #e65100;
        }
        button {
            padding: 10px 15px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        #debug {
            font-family: monospace;
            white-space: pre;
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>Code 39 Barcode Scanner</h1>
    <button id="startButton">Start Scanner</button>
    <button id="stopButton" disabled>Stop Scanner</button>
    
    <div id="scanner-container"></div>
    <div id="result">Ready to scan...</div>
    
    <h3>Debug Information:</h3>
    <div id="debug"></div>

    <script>
        const debugElement = document.getElementById('debug');
        const resultDiv = document.getElementById('result');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        let scannerActive = false;
        
        function logDebug(message) {
            debugElement.textContent += message + '\n';
            debugElement.scrollTop = debugElement.scrollHeight;
        }

        function initScanner() {
            logDebug('Initializing scanner for Code 39...');
            
            Quagga.init({
                inputStream: {
                    name: "Live",
                    type: "LiveStream",
                    target: document.querySelector('#scanner-container'),
                    constraints: {
                        facingMode: "environment",
                        width: 640,
                        height: 480
                    },
                },
                decoder: {
                    readers: ["code_39_reader"], // Only Code 39
                    multiple: false
                },
                locate: true,
                debug: {
                    drawBoundingBox: true,
                    showFrequency: true,
                    drawScanline: true,
                    showPattern: true
                }
            }, function(err) {
                if (err) {
                    logDebug('Scanner initialization error: ' + err);
                    resultDiv.textContent = "Scanner error: " + err.message;
                    resultDiv.className = "error";
                    return;
                }
                
                Quagga.start();
                scannerActive = true;
                startButton.disabled = true;
                stopButton.disabled = false;
                resultDiv.textContent = "Scanning for Code 39 barcodes...";
                logDebug('Scanner started successfully');
            });
        }

        function stopScanner() {
            if (scannerActive) {
                Quagga.stop();
                scannerActive = false;
                startButton.disabled = false;
                stopButton.disabled = true;
                resultDiv.textContent = "Scanner stopped";
                logDebug('Scanner stopped');
            }
        }

       Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        logDebug('Detected: ' + code);
        
        // Use your PC's actual IP below
        fetch('http://192.168.8.112:8000/scan', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ barcode: code })
        })
        .then(response => {
            if (!response.ok) throw new Error('HTTP ' + response.status);
            return response.json();
        })
        .then(data => {
            logDebug('Server response: ' + JSON.stringify(data));
            // Update UI...
        })
        .catch(error => {
            logDebug('FAILED: ' + error.message);
            resultDiv.className = "error";
            resultDiv.textContent = "Error sending to server: " + error.message;
        });
    });

        startButton.addEventListener('click', initScanner);
        stopButton.addEventListener('click', stopScanner);

        // Add keyboard shortcut (Space to start/stop)
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                if (scannerActive) stopScanner();
                else initScanner();
            }
        });
    </script>
</body>
</html>
